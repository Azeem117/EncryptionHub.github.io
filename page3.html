<!--
    Encryption Hub
    Copyright (C) 2024  MD AZEEM

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encryption 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
        }
        .container {
            background-color: #2d3748;
            border: 2px solid #4a5568;
        }
        .btn {
            @apply px-6 py-3 font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105;
        }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-white">

    <div class="container w-full max-w-xl mx-auto rounded-xl p-8 shadow-2xl">
        <h1 class="text-3xl font-bold text-center text-teal-300 mb-2">Encryption 3.0</h1>
        <p class="text-center text-sm text-gray-400 mb-6">Uses AES-GCM and PBKDF2 for strong encryption.</p>

        <!-- Main application area -->
        <div class="space-y-6">
            <!-- File input section -->
            <div>
                <label for="fileInput" class="block text-gray-300 font-medium mb-2">
                    Select a file to encrypt or decrypt:
                </label>
                <input type="file" id="fileInput"
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-teal-500 file:text-white
                              hover:file:bg-teal-600 cursor-pointer">
            </div>

            <!-- Key input section -->
            <div>
                <label for="keyInput" class="block text-gray-300 font-medium mb-2">
                    Enter your secret key:
                </label>
                <div class="relative">
                    <input type="password" id="keyInput" placeholder="Enter your key..."
                           class="w-full p-3 pr-10 rounded-full bg-gray-700 text-white placeholder-gray-400
                                  focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <button id="togglePassword" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                         <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.879 10.121A4.989 4.989 0 0112 15a4.989 4.989 0 01-1.879-4.879m3.758 3.758a.5.5 0 11-.707-.707m.707.707a.5.5 0 10-.707-.707" />
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m2-2l2-2" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="encryptBtn" class="btn bg-blue-500 hover:bg-blue-600 flex-1 rounded-full">Encrypt File</button>
                <button id="decryptBtn" class="btn bg-green-500 hover:bg-green-600 flex-1 rounded-full">Decrypt File</button>
            </div>

            <!-- Status and download area -->
            <div class="mt-6 text-center">
                <p id="statusMessage" class="text-sm text-gray-400 min-h-[20px]"></p>
                <div id="loader" class="mx-auto hidden"></div>
                <a id="downloadLink" href="#" download class="hidden mt-4 inline-block btn bg-teal-500 hover:bg-teal-600 rounded-full">Download File</a>
            </div>

            <!-- Disclaimer -->
            <div class="mt-8 pt-4 border-t border-gray-600 text-sm text-gray-400 text-center">
                <p>
                    <span class="font-bold text-red-400">Disclaimer:</span> This tool uses cryptographically secure algorithms (AES-GCM and PBKDF2) but is a client-side implementation. For maximum security, always use a dedicated, server-side cryptographic solution and a strong, unique password for each file.
                </p>
                <p class="mt-1 text-xs text-gray-600">Note: PBKDF2 with 100,000 iterations is secure but may be slow on older or less powerful devices.</p>
            </div>
            <div class="mt-4 text-center text-sm text-gray-500">
                <p> MD AZEEM &copy; 2025. All Rights Reserved.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const keyInput = document.getElementById('keyInput');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const eyeIcon = document.getElementById('eye-icon');
            const eyeOffIcon = document.getElementById('eye-off-icon');
            const encryptBtn = document.getElementById('encryptBtn');
            const decryptBtn = document.getElementById('decryptBtn');
            const statusMessage = document.getElementById('statusMessage');
            const downloadLink = document.getElementById('downloadLink');
            const loader = document.getElementById('loader');

            const iterations = 100000;
            const keyLength = 256;
            let originalFile = null;

            // Toggle password visibility
            togglePasswordBtn.addEventListener('click', () => {
                const type = keyInput.getAttribute('type') === 'password' ? 'text' : 'password';
                keyInput.setAttribute('type', type);
                eyeIcon.classList.toggle('hidden');
                eyeOffIcon.classList.toggle('hidden');
            });


            // Function to handle the selected file
            fileInput.addEventListener('change', (event) => {
                originalFile = event.target.files[0];
                if (originalFile) {
                    statusMessage.textContent = `File selected: ${originalFile.name}`;
                    downloadLink.classList.add('hidden');
                } else {
                    statusMessage.textContent = 'No file selected.';
                }
            });

            // Function to set the UI state
            function setUIState(isProcessing) {
                encryptBtn.disabled = isProcessing;
                decryptBtn.disabled = isProcessing;
                fileInput.disabled = isProcessing;
                keyInput.disabled = isProcessing;
                if (isProcessing) {
                    loader.classList.remove('hidden');
                    downloadLink.classList.add('hidden');
                } else {
                    loader.classList.add('hidden');
                }
            }
            
            // Function to derive a key from a password using PBKDF2
            async function deriveKeyFromPassword(password, salt, keyUsage) {
                const passwordBuffer = new TextEncoder().encode(password);
                const baseKey = await crypto.subtle.importKey(
                    "raw",
                    passwordBuffer,
                    { name: "PBKDF2" },
                    false,
                    ["deriveKey"]
                );

                return await crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: iterations,
                        hash: "SHA-256",
                    },
                    baseKey,
                    { name: "AES-GCM", length: keyLength },
                    false,
                    keyUsage
                );
            }

            // Handle Encrypt button click
            encryptBtn.addEventListener('click', async () => {
                if (!originalFile) {
                    statusMessage.textContent = "Please select a file first.";
                    return;
                }
                if (!keyInput.value) {
                    statusMessage.textContent = "Please enter a key.";
                    return;
                }

                setUIState(true);
                statusMessage.textContent = "Deriving key with PBKDF2...";

                try {
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    
                    const derivedKey = await deriveKeyFromPassword(keyInput.value, salt, ["encrypt"]);

                    statusMessage.textContent = "Encrypting file...";

                    // Read the entire file into memory as an ArrayBuffer
                    const fileBuffer = await originalFile.arrayBuffer();

                    // Encrypt the file buffer
                    const encryptedBuffer = await crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv },
                        derivedKey,
                        fileBuffer
                    );

                    // Safer concatenation using a single Uint8Array
                    const combined = new Uint8Array(salt.length + iv.length + encryptedBuffer.byteLength);
                    combined.set(salt, 0);
                    combined.set(iv, salt.length);
                    combined.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);
                    
                    const encryptedBlob = new Blob([combined], { type: 'application/octet-stream' });
                    
                    const fileNameParts = originalFile.name.split('.');
                    const newFileName = fileNameParts.length > 1 ? fileNameParts.slice(0, -1).join('.') + '_secure.enc' : originalFile.name + '_secure.enc';

                    const url = URL.createObjectURL(encryptedBlob);
                    downloadLink.href = url;
                    downloadLink.download = newFileName;
                    downloadLink.textContent = `Download Encrypted File (${newFileName})`;
                    downloadLink.classList.remove('hidden');
                    
                    downloadLink.addEventListener('click', () => {
                        setTimeout(() => URL.revokeObjectURL(url), 500);
                    });

                    statusMessage.textContent = "Encryption complete!";
                    setUIState(false);

                } catch (error) {
                    statusMessage.textContent = `Encryption failed: ${error.message}`;
                    console.error(error);
                    setUIState(false);
                }
            });

            // Handle Decrypt button click
            decryptBtn.addEventListener('click', async () => {
                if (!originalFile) {
                    statusMessage.textContent = "Please select a file first.";
                    return;
                }
                if (!keyInput.value) {
                    statusMessage.textContent = "Please enter a key.";
                    return;
                }

                setUIState(true);
                statusMessage.textContent = "Deriving key with PBKDF2...";

                try {
                    // Read the entire file into memory as an ArrayBuffer
                    const encryptedFileBuffer = await originalFile.arrayBuffer();

                    // Extract salt and IV
                    if (encryptedFileBuffer.byteLength < 28) {
                        statusMessage.textContent = "Decryption failed. The file is corrupted or not a valid encrypted file.";
                        setUIState(false);
                        return;
                    }

                    const salt = new Uint8Array(encryptedFileBuffer.slice(0, 16));
                    const iv = new Uint8Array(encryptedFileBuffer.slice(16, 28));
                    const encryptedData = new Uint8Array(encryptedFileBuffer.slice(28));

                    const derivedKey = await deriveKeyFromPassword(keyInput.value, salt, ["decrypt"]);

                    statusMessage.textContent = "Decrypting file...";

                    // Decrypt the data
                    const decryptedBuffer = await crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv },
                        derivedKey,
                        encryptedData
                    );

                    const fileNameParts = originalFile.name.split('_secure.enc');
                    const newFileName = fileNameParts.length > 1 ? fileNameParts[0] : 'decrypted_file';

                    const decryptedBlob = new Blob([decryptedBuffer], { type: 'application/octet-stream' });
                    
                    const url = URL.createObjectURL(decryptedBlob);
                    downloadLink.href = url;
                    downloadLink.download = newFileName;
                    downloadLink.textContent = `Download Decrypted File (${newFileName})`;
                    downloadLink.classList.remove('hidden');

                    downloadLink.addEventListener('click', () => {
                        setTimeout(() => URL.revokeObjectURL(url), 500);
                    });

                    statusMessage.textContent = "Decryption complete!";
                    setUIState(false);

                } catch (error) {
                    if (error.name === 'OperationError') {
                        statusMessage.textContent = "Decryption failed. The secret key is incorrect or the file has been tampered with.";
                    } else {
                        statusMessage.textContent = `Decryption failed. Please check your file. Error: ${error.message}`;
                    }
                    console.error(error);
                    setUIState(false);
                }
            });
        });
    </script>
</body>
</html>
